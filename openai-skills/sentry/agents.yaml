version: v1
kind: ServiceTemplate
variables: []

metadata:
  name: openai-sentry
  description: An agent that uses OpenAI's sentry skill and powered by gpt-5.2
  annotations:
    meshagent.service.id: meshagent.openai-sentry

agents:
  - name: openai-sentry
    annotations:
      meshagent.agent.type: ChatBot

container:
  image: us-central1-docker.pkg.dev/meshagent-life/meshagent-public/cli:{SERVER_VERSION}-esgz
  command: /bin/bash /var/start.sh
  storage:
    room:
    - path: /data
      read_only: false
    files:
    - path: /var/start.sh
      text: |
          #!/bin/bash
          
          set -e
          
          mkdir -p /data/skills
          if [ -d /skills ]; then
            cp -R -n /skills/* /data/skills/ 2>/dev/null || true
          fi
          
          exec /usr/bin/meshagent chatbot join \
            --model=gpt-5.2 \
            --require-storage \
            --require-web-search \
            --rule="you can use the storage tool to read skills not just the shell tool" \
            --rule="when a question could be served by a skill, read the skill and follow the pattern specified in the skill" \
            --rule="when using the storage tool to read files attached or referenced by the user, in the room, or output by the shell tool, the file path should be prefixed with /data." \
            --rule="when using the storage tool to read skills, the path should be prefixed with /data/skills (the folder where the skills are located)" \
            --storage-tool-local-path=/skills:/skills \
            --storage-tool-room-path=/:/data \
            --script-tool \
            -rr=agents/openai-sentry/rules.txt \
            --rule='You have customizable rules stored in agents/openai-sentry/rules.txt, you can use the read_file tool to read your rules. You can use the write_file tool to update the contents of the rules file or other text files. Use the read_file tool to read PDFs, examine images, or read files with a text/* mime type from attachments or files.' \
            --rule='You are a MeshAgent agent. MeshAgent is an agent operating system. You can find out more at www.meshagent.com and docs.meshagent.com' \
            --rule='You have some slash commands available' \
            --skill-dir /data/skills/sentry
    - path: /skills/sentry/SKILL.md
      text: |
          ---
          name: "sentry"
          description: "Use when the user asks to inspect Sentry issues or events, summarize recent production errors, or pull basic Sentry health data via the Sentry API; perform read-only queries with the bundled script and require `SENTRY_AUTH_TOKEN`."
          ---
          
          
          # Sentry (Read-only Observability)
          
          ## Quick start
          
          - If not already authenticated, ask the user to provide a valid `SENTRY_AUTH_TOKEN` (read-only scopes such as `project:read`, `event:read`) or to log in and create one before running commands.
          - Set `SENTRY_AUTH_TOKEN` as an env var.
          - Optional defaults: `SENTRY_ORG`, `SENTRY_PROJECT`, `SENTRY_BASE_URL`.
          - Defaults: org/project `{your-org}`/`{your-project}`, time range `24h`, environment `prod`, limit 20 (max 50).
          - Always call the Sentry API (no heuristics, no caching).
          
          If the token is missing, give the user these steps:
          1. Create a Sentry auth token: https://sentry.io/settings/account/api/auth-tokens/
          2. Create a token with read-only scopes such as `project:read`, `event:read`, and `org:read`.
          3. Set `SENTRY_AUTH_TOKEN` as an environment variable in their system.
          4. Offer to guide them through setting the environment variable for their OS/shell if needed.
          - Never ask the user to paste the full token in chat. Ask them to set it locally and confirm when ready.
          
          ## Core tasks (use bundled script)
          
          Use `scripts/sentry_api.py` for deterministic API calls. It handles pagination and retries once on transient errors.
          
          ## Skill path (set once)
          
          ```bash
          export CODEX_HOME="${CODEX_HOME:-$HOME/.codex}"
          export SENTRY_API="$CODEX_HOME/skills/sentry/scripts/sentry_api.py"
          ```
          
          User-scoped skills install under `$CODEX_HOME/skills` (default: `~/.codex/skills`).
          
          ### 1) List issues (ordered by most recent)
          
          ```bash
          python3 "$SENTRY_API" \
            list-issues \
            --org {your-org} \
            --project {your-project} \
            --environment prod \
            --time-range 24h \
            --limit 20 \
            --query "is:unresolved"
          ```
          
          ### 2) Resolve an issue short ID to issue ID
          
          ```bash
          python3 "$SENTRY_API" \
            list-issues \
            --org {your-org} \
            --project {your-project} \
            --query "ABC-123" \
            --limit 1
          ```
          
          Use the returned `id` for issue detail or events.
          
          ### 3) Issue detail
          
          ```bash
          python3 "$SENTRY_API" \
            issue-detail \
            1234567890
          ```
          
          ### 4) Issue events
          
          ```bash
          python3 "$SENTRY_API" \
            issue-events \
            1234567890 \
            --limit 20
          ```
          
          ### 5) Event detail (no stack traces by default)
          
          ```bash
          python3 "$SENTRY_API" \
            event-detail \
            --org {your-org} \
            --project {your-project} \
            abcdef1234567890
          ```
          
          ## API requirements
          
          Always use these endpoints (GET only):
          
          - List issues: `/api/0/projects/{org_slug}/{project_slug}/issues/`
          - Issue detail: `/api/0/issues/{issue_id}/`
          - Events for issue: `/api/0/issues/{issue_id}/events/`
          - Event detail: `/api/0/projects/{org_slug}/{project_slug}/events/{event_id}/`
          
          ## Inputs and defaults
          
          - `org_slug`, `project_slug`: default to `{your-org}`/`{your-project}` (avoid non-prod orgs).
          - `time_range`: default `24h` (pass as `statsPeriod`).
          - `environment`: default `prod`.
          - `limit`: default 20, max 50 (paginate until limit reached).
          - `search_query`: optional `query` parameter.
          - `issue_short_id`: resolve via list-issues query first.
          
          ## Output formatting rules
          
          - Issue list: show title, short_id, status, first_seen, last_seen, count, environments, top_tags; order by most recent.
          - Event detail: include culprit, timestamp, environment, release, url.
          - If no results, state explicitly.
          - Redact PII in output (emails, IPs). Do not print raw stack traces.
          - Never echo auth tokens.
          
          ## Golden test inputs
          
          - Org: `{your-org}`
          - Project: `{your-project}`
          - Issue short ID: `{ABC-123}`
          
          Example prompt: “List the top 10 open issues for prod in the last 24h.”
          Expected: ordered list with titles, short IDs, counts, last seen.
  environment:
    - name: OPENAI_MAX_TOKENS
      value: "8192"
    - name: MESHAGENT_TOKEN
      token:  
        identity: openai-sentry
        api:
          livekit: {}
          queues:
            list: true
          messaging:
            broadcast: true
            list: true
            send: true
          database:
            list_tables: true
          sync: {}
          storage: {}
          containers:
            logs: true
            use_containers: true
          developer:
            logs: true
          agents:
            register_agent: true
            register_public_toolkit: true
            register_private_toolkit: true
            call: true
            use_agents: true
            use_tools: true
            allowed_toolkits: null

