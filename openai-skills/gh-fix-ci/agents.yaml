version: v1
kind: ServiceTemplate
variables: []

metadata:
  name: openai-gh-fix-ci
  description: An agent that uses OpenAI's gh-fix-ci skill and powered by gpt-5.2
  annotations:
    meshagent.service.id: meshagent.openai-gh-fix-ci

agents:
  - name: openai-gh-fix-ci
    annotations:
      meshagent.agent.type: ChatBot

container:
  image: us-central1-docker.pkg.dev/meshagent-life/meshagent-public/cli:{SERVER_VERSION}-esgz
  command: /bin/bash /var/start.sh
  storage:
    room:
    - path: /data
      read_only: false
    files:
    - path: /var/start.sh
      text: |
          #!/bin/bash
          
          set -e
          
          mkdir -p /data/skills
          if [ -d /skills ]; then
            cp -R -n /skills/* /data/skills/ 2>/dev/null || true
          fi
          
          exec /usr/bin/meshagent chatbot join \
            --model=gpt-5.2 \
            --require-storage \
            --require-web-search \
            --rule="you can use the storage tool to read skills not just the shell tool" \
            --rule="when a question could be served by a skill, read the skill and follow the pattern specified in the skill" \
            --rule="when using the storage tool to read files attached or referenced by the user, in the room, or output by the shell tool, the file path should be prefixed with /data." \
            --rule="when using the storage tool to read skills, the path should be prefixed with /data/skills (the folder where the skills are located)" \
            --storage-tool-local-path=/skills:/skills \
            --storage-tool-room-path=/:/data \
            --script-tool \
            -rr=agents/openai-gh-fix-ci/rules.txt \
            --rule='You have customizable rules stored in agents/openai-gh-fix-ci/rules.txt, you can use the read_file tool to read your rules. You can use the write_file tool to update the contents of the rules file or other text files. Use the read_file tool to read PDFs, examine images, or read files with a text/* mime type from attachments or files.' \
            --rule='You are a MeshAgent agent. MeshAgent is an agent operating system. You can find out more at www.meshagent.com and docs.meshagent.com' \
            --rule='You have some slash commands available' \
            --skill-dir /data/skills/gh-fix-ci
    - path: /skills/gh-fix-ci/SKILL.md
      text: |
          ---
          name: "gh-fix-ci"
          description: "Use when a user asks to debug or fix failing GitHub PR checks that run in GitHub Actions; use `gh` to inspect checks and logs, summarize failure context, draft a fix plan, and implement only after explicit approval. Treat external providers (for example Buildkite) as out of scope and report only the details URL."
          ---
          
          
          # Gh Pr Checks Plan Fix
          
          ## Overview
          
          Use gh to locate failing PR checks, fetch GitHub Actions logs for actionable failures, summarize the failure snippet, then propose a fix plan and implement after explicit approval.
          - If a plan-oriented skill (for example `create-plan`) is available, use it; otherwise draft a concise plan inline and request approval before implementing.
          
          Prereq: authenticate with the standard GitHub CLI once (for example, run `gh auth login`), then confirm with `gh auth status` (repo + workflow scopes are typically required).
          
          ## Inputs
          
          - `repo`: path inside the repo (default `.`)
          - `pr`: PR number or URL (optional; defaults to current branch PR)
          - `gh` authentication for the repo host
          
          ## Quick start
          
          - `python "<path-to-skill>/scripts/inspect_pr_checks.py" --repo "." --pr "<number-or-url>"`
          - Add `--json` if you want machine-friendly output for summarization.
          
          ## Workflow
          
          1. Verify gh authentication.
             - Run `gh auth status` in the repo.
             - If unauthenticated, ask the user to run `gh auth login` (ensuring repo + workflow scopes) before proceeding.
          2. Resolve the PR.
             - Prefer the current branch PR: `gh pr view --json number,url`.
             - If the user provides a PR number or URL, use that directly.
          3. Inspect failing checks (GitHub Actions only).
             - Preferred: run the bundled script (handles gh field drift and job-log fallbacks):
               - `python "<path-to-skill>/scripts/inspect_pr_checks.py" --repo "." --pr "<number-or-url>"`
               - Add `--json` for machine-friendly output.
             - Manual fallback:
               - `gh pr checks <pr> --json name,state,bucket,link,startedAt,completedAt,workflow`
                 - If a field is rejected, rerun with the available fields reported by `gh`.
               - For each failing check, extract the run id from `detailsUrl` and run:
                 - `gh run view <run_id> --json name,workflowName,conclusion,status,url,event,headBranch,headSha`
                 - `gh run view <run_id> --log`
               - If the run log says it is still in progress, fetch job logs directly:
                 - `gh api "/repos/<owner>/<repo>/actions/jobs/<job_id>/logs" > "<path>"`
          4. Scope non-GitHub Actions checks.
             - If `detailsUrl` is not a GitHub Actions run, label it as external and only report the URL.
             - Do not attempt Buildkite or other providers; keep the workflow lean.
          5. Summarize failures for the user.
             - Provide the failing check name, run URL (if any), and a concise log snippet.
             - Call out missing logs explicitly.
          6. Create a plan.
             - Use the `create-plan` skill to draft a concise plan and request approval.
          7. Implement after approval.
             - Apply the approved plan, summarize diffs/tests, and ask about opening a PR.
          8. Recheck status.
             - After changes, suggest re-running the relevant tests and `gh pr checks` to confirm.
          
          ## Bundled Resources
          
          ### scripts/inspect_pr_checks.py
          
          Fetch failing PR checks, pull GitHub Actions logs, and extract a failure snippet. Exits non-zero when failures remain so it can be used in automation.
          
          Usage examples:
          - `python "<path-to-skill>/scripts/inspect_pr_checks.py" --repo "." --pr "123"`
          - `python "<path-to-skill>/scripts/inspect_pr_checks.py" --repo "." --pr "https://github.com/org/repo/pull/123" --json`
          - `python "<path-to-skill>/scripts/inspect_pr_checks.py" --repo "." --max-lines 200 --context 40`
  environment:
    - name: OPENAI_MAX_TOKENS
      value: "8192"
    - name: MESHAGENT_TOKEN
      token:  
        identity: openai-gh-fix-ci
        api:
          livekit: {}
          queues:
            list: true
          messaging:
            broadcast: true
            list: true
            send: true
          database:
            list_tables: true
          sync: {}
          storage: {}
          containers:
            logs: true
            use_containers: true
          developer:
            logs: true
          agents:
            register_agent: true
            register_public_toolkit: true
            register_private_toolkit: true
            call: true
            use_agents: true
            use_tools: true
            allowed_toolkits: null

