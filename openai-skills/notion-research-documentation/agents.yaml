version: v1
kind: ServiceTemplate
variables: []

metadata:
  name: openai-notion-research-documentation
  description: An agent that uses OpenAI's notion-research-documentation skill and powered by gpt-5.2
  annotations:
    meshagent.service.id: meshagent.openai-notion-research-documentation

agents:
  - name: openai-notion-research-documentation
    annotations:
      meshagent.agent.type: ChatBot

container:
  image: us-central1-docker.pkg.dev/meshagent-life/meshagent-public/cli:{SERVER_VERSION}-esgz
  command: /bin/bash /var/start.sh
  storage:
    room:
    - path: /data
      read_only: false
    files:
    - path: /var/start.sh
      text: |
          #!/bin/bash
          
          set -e
          
          mkdir -p /data/skills
          if [ -d /skills ]; then
            cp -R -n /skills/* /data/skills/ 2>/dev/null || true
          fi
          
          exec /usr/bin/meshagent chatbot join \
            --model=gpt-5.2 \
            --require-storage \
            --require-web-search \
            --rule="you can use the storage tool to read skills not just the shell tool" \
            --rule="when a question could be served by a skill, read the skill and follow the pattern specified in the skill" \
            --rule="when using the storage tool to read files attached or referenced by the user, in the room, or output by the shell tool, the file path should be prefixed with /data." \
            --rule="when using the storage tool to read skills, the path should be prefixed with /data/skills (the folder where the skills are located)" \
            --storage-tool-local-path=/skills:/skills \
            --storage-tool-room-path=/:/data \
            --script-tool \
            -rr=agents/openai-notion-research-documentation/rules.txt \
            --rule='You have customizable rules stored in agents/openai-notion-research-documentation/rules.txt, you can use the read_file tool to read your rules. You can use the write_file tool to update the contents of the rules file or other text files. Use the read_file tool to read PDFs, examine images, or read files with a text/* mime type from attachments or files.' \
            --rule='You are a MeshAgent agent. MeshAgent is an agent operating system. You can find out more at www.meshagent.com and docs.meshagent.com' \
            --rule='You have some slash commands available' \
            --skill-dir /data/skills/notion-research-documentation
    - path: /skills/notion-research-documentation/SKILL.md
      text: |
          ---
          name: notion-research-documentation
          description: Research across Notion and synthesize into structured documentation; use when gathering info from multiple Notion sources to produce briefs, comparisons, or reports with citations.
          metadata:
            short-description: Research Notion content and produce briefs/reports
          ---
          
          # Research & Documentation
          
          Pull relevant Notion pages, synthesize findings, and publish clear briefs or reports (with citations and links to sources).
          
          ## Quick start
          1) Find sources with `Notion:notion-search` using targeted queries; confirm scope with the user.
          2) Fetch pages via `Notion:notion-fetch`; note key sections and capture citations (`reference/citations.md`).
          3) Choose output format (brief, summary, comparison, comprehensive report) using `reference/format-selection-guide.md`.
          4) Draft in Notion with `Notion:notion-create-pages` using the matching template (quick, summary, comparison, comprehensive).
          5) Link sources and add a references/citations section; update as new info arrives with `Notion:notion-update-page`.
          
          ## Workflow
          ### 0) If any MCP call fails because Notion MCP is not connected, pause and set it up:
          1. Add the Notion MCP:
             - `codex mcp add notion --url https://mcp.notion.com/mcp`
          2. Enable remote MCP client:
             - Set `[features].rmcp_client = true` in `config.toml` **or** run `codex --enable rmcp_client`
          3. Log in with OAuth:
             - `codex mcp login notion`
          
          After successful login, the user will have to restart codex. You should finish your answer and tell them so when they try again they can continue with Step 1.
          
          ### 1) Gather sources
          - Search first (`Notion:notion-search`); refine queries, and ask the user to confirm if multiple results appear.
          - Fetch relevant pages (`Notion:notion-fetch`), skim for facts, metrics, claims, constraints, and dates.
          - Track each source URL/ID for later citation; prefer direct quotes for critical facts.
          
          ### 2) Select the format
          - Quick readout → quick brief.
          - Single-topic dive → research summary.
          - Option tradeoffs → comparison.
          - Deep dive / exec-ready → comprehensive report.
          - See `reference/format-selection-guide.md` for when to pick each.
          
          ### 3) Synthesize
          - Outline before writing; group findings by themes/questions.
          - Note evidence with source IDs; flag gaps or contradictions.
          - Keep user goal in view (decision, summary, plan, recommendation).
          
          ### 4) Create the doc
          - Pick the matching template in `reference/` (brief, summary, comparison, comprehensive) and adapt it.
          - Create the page with `Notion:notion-create-pages`; include title, summary, key findings, supporting evidence, and recommendations/next steps when relevant.
          - Add citations inline and a references section; link back to source pages.
          
          ### 5) Finalize & handoff
          - Add highlights, risks, and open questions.
          - If the user needs follow-ups, create tasks or a checklist in the page; link any task database entries if applicable.
          - Share a short changelog or status using `Notion:notion-update-page` when updating.
          
          ## References and examples
          - `reference/` — search tactics, format selection, templates, and citation rules (e.g., `advanced-search.md`, `format-selection-guide.md`, `research-summary-template.md`, `comparison-template.md`, `citations.md`).
          - `examples/` — end-to-end walkthroughs (e.g., `competitor-analysis.md`, `technical-investigation.md`, `market-research.md`, `trip-planning.md`).
  environment:
    - name: OPENAI_MAX_TOKENS
      value: "8192"
    - name: MESHAGENT_TOKEN
      token:  
        identity: openai-notion-research-documentation
        api:
          livekit: {}
          queues:
            list: true
          messaging:
            broadcast: true
            list: true
            send: true
          database:
            list_tables: true
          sync: {}
          storage: {}
          containers:
            logs: true
            use_containers: true
          developer:
            logs: true
          agents:
            register_agent: true
            register_public_toolkit: true
            register_private_toolkit: true
            call: true
            use_agents: true
            use_tools: true
            allowed_toolkits: null

