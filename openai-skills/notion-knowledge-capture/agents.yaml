version: v1
kind: ServiceTemplate
variables: []

metadata:
  name: openai-notion-knowledge-capture
  description: An agent that uses OpenAI's notion-knowledge-capture skill and powered by gpt-5.2
  annotations:
    meshagent.service.id: meshagent.openai-notion-knowledge-capture

agents:
  - name: openai-notion-knowledge-capture
    annotations:
      meshagent.agent.type: ChatBot

container:
  image: us-central1-docker.pkg.dev/meshagent-life/meshagent-public/cli:{SERVER_VERSION}-esgz
  command: /bin/bash /var/start.sh
  storage:
    room:
    - path: /data
      read_only: false
    files:
    - path: /var/start.sh
      text: |
          #!/bin/bash
          
          set -e
          
          mkdir -p /data/skills
          if [ -d /skills ]; then
            cp -R -n /skills/* /data/skills/ 2>/dev/null || true
          fi
          
          exec /usr/bin/meshagent chatbot join \
            --model=gpt-5.2 \
            --require-storage \
            --require-web-search \
            --rule="you can use the storage tool to read skills not just the shell tool" \
            --rule="when a question could be served by a skill, read the skill and follow the pattern specified in the skill" \
            --rule="when using the storage tool to read files attached or referenced by the user, in the room, or output by the shell tool, the file path should be prefixed with /data." \
            --rule="when using the storage tool to read skills, the path should be prefixed with /data/skills (the folder where the skills are located)" \
            --storage-tool-local-path=/skills:/skills \
            --storage-tool-room-path=/:/data \
            --script-tool \
            -rr=agents/openai-notion-knowledge-capture/rules.txt \
            --rule='You have customizable rules stored in agents/openai-notion-knowledge-capture/rules.txt, you can use the read_file tool to read your rules. You can use the write_file tool to update the contents of the rules file or other text files. Use the read_file tool to read PDFs, examine images, or read files with a text/* mime type from attachments or files.' \
            --rule='You are a MeshAgent agent. MeshAgent is an agent operating system. You can find out more at www.meshagent.com and docs.meshagent.com' \
            --rule='You have some slash commands available' \
            --skill-dir /data/skills/notion-knowledge-capture
    - path: /skills/notion-knowledge-capture/SKILL.md
      text: |
          ---
          name: notion-knowledge-capture
          description: Capture conversations and decisions into structured Notion pages; use when turning chats/notes into wiki entries, how-tos, decisions, or FAQs with proper linking.
          metadata:
            short-description: Capture conversations into structured Notion pages
          ---
          
          # Knowledge Capture
          
          Convert conversations and notes into structured, linkable Notion pages for easy reuse.
          
          ## Quick start
          1) Clarify what to capture (decision, how-to, FAQ, learning, documentation) and target audience.
          2) Identify the right database/template in `reference/` (team wiki, how-to, FAQ, decision log, learning, documentation).
          3) Pull any prior context from Notion with `Notion:notion-search` → `Notion:notion-fetch` (existing pages to update/link).
          4) Draft the page with `Notion:notion-create-pages` using the database’s schema; include summary, context, source links, and tags/owners.
          5) Link from hub pages and related records; update status/owners with `Notion:notion-update-page` as the source evolves.
          
          ## Workflow
          ### 0) If any MCP call fails because Notion MCP is not connected, pause and set it up:
          1. Add the Notion MCP:
             - `codex mcp add notion --url https://mcp.notion.com/mcp`
          2. Enable remote MCP client:
             - Set `[features].rmcp_client = true` in `config.toml` **or** run `codex --enable rmcp_client`
          3. Log in with OAuth:
             - `codex mcp login notion`
          
          After successful login, the user will have to restart codex. You should finish your answer and tell them so when they try again they can continue with Step 1.
          
          ### 1) Define the capture
          - Ask purpose, audience, freshness, and whether this is new or an update.
          - Determine content type: decision, how-to, FAQ, concept/wiki entry, learning/note, documentation page.
          
          ### 2) Locate destination
          - Pick the correct database using `reference/*-database.md` guides; confirm required properties (title, tags, owner, status, date, relations).
          - If multiple candidate databases, ask the user which to use; otherwise, create in the primary wiki/documentation DB.
          
          ### 3) Extract and structure
          - Extract facts, decisions, actions, and rationale from the conversation.
          - For decisions, record alternatives, rationale, and outcomes.
          - For how-tos/docs, capture steps, pre-reqs, links to assets/code, and edge cases.
          - For FAQs, phrase as Q&A with concise answers and links to deeper docs.
          
          ### 4) Create/update in Notion
          - Use `Notion:notion-create-pages` with the correct `data_source_id`; set properties (title, tags, owner, status, dates, relations).
          - Use templates in `reference/` to structure content (section headers, checklists).
          - If updating an existing page, fetch then edit via `Notion:notion-update-page`.
          
          ### 5) Link and surface
          - Add relations/backlinks to hub pages, related specs/docs, and teams.
          - Add a short summary/changelog for future readers.
          - If follow-up tasks exist, create tasks in the relevant database and link them.
          
          ## References and examples
          - `reference/` — database schemas and templates (e.g., `team-wiki-database.md`, `how-to-guide-database.md`, `faq-database.md`, `decision-log-database.md`, `documentation-database.md`, `learning-database.md`, `database-best-practices.md`).
          - `examples/` — capture patterns in practice (e.g., `decision-capture.md`, `how-to-guide.md`, `conversation-to-faq.md`).
  environment:
    - name: OPENAI_MAX_TOKENS
      value: "8192"
    - name: MESHAGENT_TOKEN
      token:  
        identity: openai-notion-knowledge-capture
        api:
          livekit: {}
          queues:
            list: true
          messaging:
            broadcast: true
            list: true
            send: true
          database:
            list_tables: true
          sync: {}
          storage: {}
          containers:
            logs: true
            use_containers: true
          developer:
            logs: true
          agents:
            register_agent: true
            register_public_toolkit: true
            register_private_toolkit: true
            call: true
            use_agents: true
            use_tools: true
            allowed_toolkits: null

