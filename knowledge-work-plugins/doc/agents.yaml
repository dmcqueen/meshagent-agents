version: v1
kind: ServiceTemplate
variables: []

metadata:
  name: openai-doc
  description: An agent that uses OpenAI's doc skill and powered by gpt-5.2
  annotations:
    meshagent.service.id: meshagent.openai-doc

agents:
  - name: openai-doc
    annotations:
      meshagent.agent.type: ChatBot

container:
  image: us-central1-docker.pkg.dev/meshagent-life/meshagent-public/cli:{SERVER_VERSION}-esgz
  command: /bin/bash /var/start.sh
  storage:
    room:
    - path: /data
      read_only: false
    files:
    - path: /var/start.sh
      text: |
          #!/bin/bash
          
          set -e
          
          mkdir -p /data/skills
          if [ -d /skills ]; then
            cp -R -n /skills/* /data/skills/ 2>/dev/null || true
          fi
          
          exec /usr/bin/meshagent chatbot join \
            --model=gpt-5.2 \
            --require-storage \
            --require-web-search \
            --rule="you can use the storage tool to read skills not just the shell tool" \
            --rule="when a question could be served by a skill, read the skill and follow the pattern specified in the skill" \
            --rule="when using the storage tool to read files attached or referenced by the user, in the room, or output by the shell tool, the file path should be prefixed with /data." \
            --rule="when using the storage tool to read skills, the path should be prefixed with /data/skills (the folder where the skills are located)" \
            --storage-tool-local-path=/skills:/skills \
            --storage-tool-room-path=/:/data \
            --script-tool \
            -rr=agents/openai-doc/rules.txt \
            --rule='You have customizable rules stored in agents/openai-doc/rules.txt, you can use the read_file tool to read your rules. You can use the write_file tool to update the contents of the rules file or other text files. Use the read_file tool to read PDFs, examine images, or read files with a text/* mime type from attachments or files.' \
            --rule='You are a MeshAgent agent. MeshAgent is an agent operating system. You can find out more at www.meshagent.com and docs.meshagent.com' \
            --rule='You have some slash commands available' \
            --skill-dir /data/skills/doc
    - path: /skills/doc/SKILL.md
      text: |
          ---
          name: "doc"
          description: "Use when the task involves reading, creating, or editing `.docx` documents, especially when formatting or layout fidelity matters; prefer `python-docx` plus the bundled `scripts/render_docx.py` for visual checks."
          ---
          
          
          # DOCX Skill
          
          ## When to use
          - Read or review DOCX content where layout matters (tables, diagrams, pagination).
          - Create or edit DOCX files with professional formatting.
          - Validate visual layout before delivery.
          
          ## Workflow
          1. Prefer visual review (layout, tables, diagrams).
             - If `soffice` and `pdftoppm` are available, convert DOCX -> PDF -> PNGs.
             - Or use `scripts/render_docx.py` (requires `pdf2image` and Poppler).
             - If these tools are missing, install them or ask the user to review rendered pages locally.
          2. Use `python-docx` for edits and structured creation (headings, styles, tables, lists).
          3. After each meaningful change, re-render and inspect the pages.
          4. If visual review is not possible, extract text with `python-docx` as a fallback and call out layout risk.
          5. Keep intermediate outputs organized and clean up after final approval.
          
          ## Temp and output conventions
          - Use `tmp/docs/` for intermediate files; delete when done.
          - Write final artifacts under `output/doc/` when working in this repo.
          - Keep filenames stable and descriptive.
          
          ## Dependencies (install if missing)
          Prefer `uv` for dependency management.
          
          Python packages:
          ```
          uv pip install python-docx pdf2image
          ```
          If `uv` is unavailable:
          ```
          python3 -m pip install python-docx pdf2image
          ```
          System tools (for rendering):
          ```
          # macOS (Homebrew)
          brew install libreoffice poppler
          
          # Ubuntu/Debian
          sudo apt-get install -y libreoffice poppler-utils
          ```
          
          If installation isn't possible in this environment, tell the user which dependency is missing and how to install it locally.
          
          ## Environment
          No required environment variables.
          
          ## Rendering commands
          DOCX -> PDF:
          ```
          soffice -env:UserInstallation=file:///tmp/lo_profile_$$ --headless --convert-to pdf --outdir $OUTDIR $INPUT_DOCX
          ```
          
          PDF -> PNGs:
          ```
          pdftoppm -png $OUTDIR/$BASENAME.pdf $OUTDIR/$BASENAME
          ```
          
          Bundled helper:
          ```
          python3 scripts/render_docx.py /path/to/file.docx --output_dir /tmp/docx_pages
          ```
          
          ## Quality expectations
          - Deliver a client-ready document: consistent typography, spacing, margins, and clear hierarchy.
          - Avoid formatting defects: clipped/overlapping text, broken tables, unreadable characters, or default-template styling.
          - Charts, tables, and visuals must be legible in rendered pages with correct alignment.
          - Use ASCII hyphens only. Avoid U+2011 (non-breaking hyphen) and other Unicode dashes.
          - Citations and references must be human-readable; never leave tool tokens or placeholder strings.
          
          ## Final checks
          - Re-render and inspect every page at 100% zoom before final delivery.
          - Fix any spacing, alignment, or pagination issues and repeat the render loop.
          - Confirm there are no leftovers (temp files, duplicate renders) unless the user asks to keep them.
  environment:
    - name: OPENAI_MAX_TOKENS
      value: "8192"
    - name: MESHAGENT_TOKEN
      token:  
        identity: openai-doc
        api:
          livekit: {}
          queues:
            list: true
          messaging:
            broadcast: true
            list: true
            send: true
          database:
            list_tables: true
          sync: {}
          storage: {}
          containers:
            logs: true
            use_containers: true
          developer:
            logs: true
          agents:
            register_agent: true
            register_public_toolkit: true
            register_private_toolkit: true
            call: true
            use_agents: true
            use_tools: true
            allowed_toolkits: null

