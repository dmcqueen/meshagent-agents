version: v1
kind: ServiceTemplate
metadata:
  name: JobPostingAssistant
  description: Agents for resume intake, analysis, and scheduled scoring.
  annotations:
    meshagent.service.id: JobPostingAssistant
    meshagent.service.readme: "JobPostingAssistant manages a hiring pipeline: mailbot ingests resume PDFs into the resumes table (deduped by normalized email), worker generates scheduled candidate scoring reports based on the job description, and chatbot answers questions and helps refine the plain-text job posting stored in room storage."
container:
  command: bash /var/start.sh
  image: "us-central1-docker.pkg.dev/meshagent-life/meshagent-public/cli:{SERVER_VERSION}-esgz"
  storage:
    room:
      - path: /data
        read_only: false
    files:
      - path: /var/start.sh
        read_only: true
        text: |
          #!/bin/bash

          mkdir -p /data/agents/JobPostingAssistant

          if [[ ! -f /data/agents/JobPostingAssistant/rules-chatbot.txt ]]; then
            cp /var/rules-chatbot.txt /data/agents/JobPostingAssistant/rules-chatbot.txt
          fi

          if [[ ! -f /data/agents/JobPostingAssistant/rules-mailbot.txt ]]; then
            cp /var/rules-mailbot.txt /data/agents/JobPostingAssistant/rules-mailbot.txt
          fi

          if [[ ! -f /data/agents/JobPostingAssistant/rules-worker.txt ]]; then
            cp /var/rules-worker.txt /data/agents/JobPostingAssistant/rules-worker.txt
          fi

          if [[ ! -f /data/agents/JobPostingAssistant/job-description.txt ]]; then
            cp /var/job-description.txt /data/agents/JobPostingAssistant/job-description.txt
          fi

          /usr/bin/meshagent multi join -c "chatbot --agent-name JobPostingAssistant --require-table-write resumes --require-storage --room-rules /agents/JobPostingAssistant/rules-chatbot.txt; mailbot --require-uuid --require-storage --require-table-write resumes --enable-attachments --room-rules /agents/JobPostingAssistant/rules-mailbot.txt --agent-name JobPostingAssistant --email-address {{MailbotEmail}} --toolkit-name=email; worker --agent-name JobPostingAssistant --queue resumes --require-shell --require-table-write resumes --require-toolkit=email --rules-file /var/tech-rules-worker.txt --room-rules /agents/JobPostingAssistant/rules-worker.txt"
      - path: /var/rules-chatbot.txt
        read_only: true
        text: |
          Answer user questions in a helpful and professional manner. You have access to the resumes database stored in the room and the job description in the room storage at /agents/JobPostingAssistant/job-description.txt. When asked about a candidate, look up their resume by resume_text and provide relevant information from their resume to answer questions. If you are asked to summarize or compare candidates, create a concise summary based on the resume text available in the resumes database and use the file /agents/JobPostingAssistant/job-description.txt in the room storage when asked about the job or role. If the user wants help writing or refining a job post, explain that you can help draft it, ask for the needed details, and produce a clear job posting. When refining the job description, edit /agents/JobPostingAssistant/job-description.txt directly as plain text (no markdown) and automatically update the file with the latest version. Use ASCII-only output for the job description: replace smart quotes with straight quotes, em/en dashes with hyphens, and remove any non-ASCII characters before writing.
      - path: /var/rules-mailbot.txt
        read_only: true
        text: |
          When resume attachments come in as PDFs extract the resume text and email for each resume. Normalize the email by trimming whitespace and lowercasing. For each resume, check the resumes table for an existing row with the same normalized email and skip only that resume if it exists to avoid duplicates; continue processing any other attachments in the same email. Insert with a uuid, submitted_at timestamp, resume_path, resume_text, and email. Do not put a pointer to the resume file in the resume_text field, put the extracted text there and put the stored file path in the resume_path field. If no resume text or no email is available, do not insert that resume into the database.
      - path: /var/rules-worker.txt
        read_only: true
        text: |
          Look at the resumes in the room database resumes and create a sorted table of resumes as rows and columns that rate each candidate on relevant dimensions given the job description in the file at the room storage root at /data/agents/JobPostingAssistant/job-description.txt. Only include the resumes since the last 24 hours. Once the table is completed put it into a html file named with the UTC timestamp and save it to the /data/agents/JobPostingAssistant/reports folder (create the folder if needed) then email the report to {{SendToEmail}}. Do not attach any resumes to this email, only the report file.
      - path: /var/tech-rules-worker.txt
        read_only: true
        text: |
          When passing the report file as an attachment to the mailbot email tool use the path starting from /agents/.
      - path: /var/job-description.txt
        read_only: true
        text: |
          Before using this agent paste or create a job post here.  

          If you need help, the JobPostingAssistant chatbot can ask clarifying questions and draft or refine the job post based on your inputs.

          Include these sections:
          - Role title, team, and one-sentence mission.
          - Responsibilities: 4-8 concrete bullets.
          - Required qualifications: skills, years of experience, certifications if needed.
          - Preferred qualifications: nice-to-have skills without inflating requirements.
          - Tools/tech and work environment.
          - Location, time zone, and work arrangement (remote/hybrid/on-site).
  environment:
    - name: MESHAGENT_TOKEN
      token:  
        identity: JobPostingAssistant
        api:
          livekit: {}
          queues:
            list: true
          messaging:
            broadcast: true
            list: true
            send: true
          database:
            list_tables: true
          sync: {}
          storage: {}
          containers:
            logs: true
            use_containers: true
          developer:
            logs: true
          agents:
            register_agent: true
            register_public_toolkit: true
            register_private_toolkit: true
            call: true
            use_agents: true
            use_tools: true
            allowed_toolkits: null
agents:
  - name: JobPostingAssistant
    annotations:
      meshagent.agent.type: ChatBot
  - name: JobPostingAssistant
    annotations:
      meshagent.agent.type: MailBot
      meshagent.agent.database.schema: '{"tables":[{"table":"resumes","schema":{"id":{"type":"text","nullable":true,"metadata":null},"resume_path":{"type":"text","nullable":true,"metadata":null}, "resume_text":{"type":"text","nullable":true,"metadata":null},"email":{"type":"text","nullable":true,"metadata":null},"submitted_at":{"type":"timestamp","nullable":true,"metadata":null}}}]}'
  - name: JobPostingAssistant
    annotations:
      meshagent.agent.type: Worker
      meshagent.agent.schedule: '{"schedule":"0 0 * * *","queue":"resumes","name":"ProcessResumes","payload":{"prompt":"Run the resume scoring workflow from /data/agents/JobPostingAssistant/rules-worker.txt"}}'
variables:
  - name: MailbotEmail
    type: email
    description: "Email address used by the mailbot to receive resumes."
  - name: SendToEmail
    description: "Email address used by the worker to send the resume scoring report."
