version: v1
kind: ServiceTemplate
metadata:
  name: ResumeAssistant
  description: Agents for resume intake, analysis, and scheduled scoring.
  annotations:
    meshagent.service.id: ResumeAssistant
    meshagent.service.readme: "Mailbot ingests resume PDFs, worker scores candidates on a schedule, and chatbot supports queries."
container:
  command: bash -c /var/start.sh
  image: "us-central1-docker.pkg.dev/meshagent-public/images/cli:{SERVER_VERSION}-esgz"
  storage:
    files:
      - path: /var/start.sh
        read_only: true
        text: !template |
          #!/bin/bash

          mkdir -p /data

          if [[ ! -f /data/rules-chatbot.txt ]]; then
            : > /data/rules-chatbot.txt
          fi

          if [[ ! -f /data/rules-mailbot.txt ]]; then
            cat <<'EOF' > /data/rules-mailbot.txt
            when a resume attachment comes in as a pdf extract the text and email and insert it with a uuid and submitted_at timestamp as a row into the room database resumes.
            EOF
          fi

          if [[ ! -f /data/rules-worker.txt ]]; then
            cat <<'EOF' > /data/rules-worker.txt
            look at the resumes in the room database resumes and create a sorted table of resumes as rows and columns that rate each candidate on relevant dimensions given the job description in the echelix-job-post.txt at the room storage root at /data/echelix-job-post.txt. Once the table is completed put it into a pdf named with a timestamp and email {{SendToEmail}} with the pdf as an attachment.
            EOF
          fi

          /usr/bin/meshagent multi join -c "chatbot --agent-name ResumeAssistant --require-table-write resumes --require-shell --room-rules /data/rules-chatbot.txt; mailbot --require-uuid --require-storage --require-table-write resumes --room-rules /data/rules-mailbot.txt --agent-name ResumeAssistant --email-address {{MailbotEmail}}; worker --agent-name ResumeAssistant --queue resumes --require-storage --require-shell --require-table-write resumes --room-rules /data/rules-worker.txt"
  environment:
    - name: MESHAGENT_TOKEN
      token:  
        identity: ResumeAssistant
        api:
          livekit: {}
          queues:
            list: true
          messaging:
            broadcast: true
            list: true
            send: true
          database:
            list_tables: true
          sync: {}
          storage: {}
          containers:
            logs: true
            use_containers: true
          developer:
            logs: true
          agents:
            register_agent: true
            register_public_toolkit: true
            register_private_toolkit: true
            call: true
            use_agents: true
            use_tools: true
            allowed_toolkits: null
agents:
  - name: ResumeAssistant
    annotations:
      meshagent.agent.type: ChatBot
  - name: ResumeAssistant
    annotations:
      meshagent.agent.type: MailBot
      meshagent.agent.database.schema: '{"tables":[{"table":"resumes","schema":{"id":{"type":"text","nullable":true,"metadata":null},"resume_text":{"type":"text","nullable":true,"metadata":null},"email":{"type":"text","nullable":true,"metadata":null},"submitted_at":{"type":"timestamp","nullable":true,"metadata":null}}}]}'
  - name: ResumeAssistant
    annotations:
      meshagent.agent.type: Worker
      meshagent.agent.schedule: '{"schedule":"0 0 * * MON","queue":"resumes","name":"ProcessResumes","payload":{"prompt":"Run the resume scoring workflow from rules-worker.txt using echelix-job-post.txt in room storage."}}'
variables:
  - name: MailbotEmail
    type: email
    description: "Email address used by the mailbot to receive resumes."
  - name: SendToEmail
    description: "Email address used by the worker to send the resume scoring report."
